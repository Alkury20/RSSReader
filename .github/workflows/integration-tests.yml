name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start backend services
        run: |
          docker-compose up -d
          sleep 30

      - name: Wait for services to be healthy
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 5; done'
          timeout 60 bash -c 'until curl -f http://localhost:3001/health; do sleep 5; done'
          timeout 60 bash -c 'until curl -f http://localhost:3002/health; do sleep 5; done'
          timeout 60 bash -c 'until curl -f http://localhost:3003/health; do sleep 5; done'

      - name: Run API tests
        run: |
          chmod +x scripts/test-api.sh
          bash scripts/test-api.sh http://localhost:3000

      - name: Check RSS feed
        run: |
          curl -f http://localhost:3000/api/feeds/rss | head -20
          curl -s http://localhost:3000/api/feeds | jq '.success'

      - name: Test authentication flow
        run: |
          REGISTER_RESPONSE=$(curl -s -X POST http://localhost:3000/api/auth/register \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"testuser$(date +%s)\",\"email\":\"test$(date +%s)@example.com\",\"password\":\"test123456\"}")
          echo "Register response: $REGISTER_RESPONSE"
          
          LOGIN_RESPONSE=$(curl -s -X POST http://localhost:3000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin123"}')
          echo "Login response: $LOGIN_RESPONSE"
          
          TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.token // empty')
          if [ -z "$TOKEN" ]; then
            echo "Failed to get token"
            exit 1
          fi
          
          PROFILE_RESPONSE=$(curl -s http://localhost:3000/api/auth/profile \
            -H "Authorization: Bearer ${TOKEN}")
          echo "Profile response: $PROFILE_RESPONSE"

      - name: Show logs on failure
        if: failure()
        run: |
          docker-compose logs

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

